# NFV Ansible Tests Repository

This repository is designed to facilitate the testing of NFV (Network Function Virtualization) configurations and performance using Ansible. It provides a structured framework for defining, running, and managing tests.

## Repository Structure

The repository is organized as follows:

- **`roles/`**: Contains reusable Ansible roles.
  - **`tests/`**: Houses test-specific roles. Each test is implemented as a role under this directory.
  - **`common/`**: Contains shared roles used across multiple tests (e.g., `run_iperf3`, `dynamic_inventory`).
  - **`provisioner/`**: Includes roles for provisioning infrastructure (e.g., `open_tofu`).
  - **`test_runner/`**: Orchestrates the execution of tests.
  - **`test_skel/`**: Provides reusable abstract logic for tests to minimize duplication.

- **`playbooks/`**: Contains playbooks for running tests.
  - **`run_test.yaml`**: The main playbook for executing tests.

- **`requirements.yaml`**: Defines external dependencies, such as Ansible collections and roles.

- **`ansible.cfg`**: Configuration file for Ansible.

## Workflow for Running Tests

1. **Define the Target and Tests**:
   - Specify the target host (`testing_target`) and the list of tests (`tests`) to run.
   - Example:
     ```bash
     ansible-playbook playbooks/run_test.yaml -e "testing_target=localhost tests=['test_tso_config', 'test_tso_iperf3_same_host']"
     ```

2. **Execution Flow**:
   - The `run_test.yaml` playbook loops through the specified tests.
   - For each test:
     - The `test_runner` role provisions the required infrastructure using the `provisioner/open_tofu` role.
     - Hosts are dynamically added to the inventory using the `common/dynamic_inventory` role.
     - The test-specific role is executed.
     - Results are collected and stored in a YAML file (`/var/lib/AnsibleTests/external_files/results.yaml`).

3. **Results**:
   - Results are printed to the console and saved to a file.
   - Optionally, a JUnitXML report can be generated by enabling the `junitxml` role in the playbook.

## Adding a New Test

To add a new test, follow these steps:

### 1. Create a Test Role

1. **Define the Role**:
   - Create a new directory under `roles/tests/` with the name of your test (e.g., `test_new_feature`).

2. **Use `test_skel` for Reusability**:
   - If your test shares logic with existing tests, include the `test_skel` role in your tasks.
   - Example:
     ```yaml
     # filepath: roles/tests/test_new_feature/tasks/main.yaml
     - name: Include abstract role
       ansible.builtin.include_role:
         name: test_skel/tso_abstract
         public: true
       vars:
         iperf3_srever: server_0
         iperf3_clients_group: "test_new_feature_clients"
         iperf3_server_ip: "{{ hostvars[iperf3_srever]['ansible_eth1']['ipv4']['address'] }}"
     ```

3. **Add Test Logic**:
   - Add any test-specific tasks to the `tasks/main.yaml` file.

4. **Document the Role**:
   - Create a `README.md` file in the role directory to describe the test, its purpose, and usage.

### 2. Define Test-Specific Files

1. **Tofu Files**:
   - Create a `tofu_files/` directory under your test role.
   - Add Terraform configuration files (e.g., `main.tf`, `servers.tf`, `networks.tf`) to define the infrastructure required for the test.

2. **Dynamic Inventory**:
   - Ensure the `tofu_files/servers.yaml` file is generated dynamically by the Terraform configuration. This file should define the test instances.

### 3. Update the Playbook

- Add the test name to the `tests` list when running the `run_test.yaml` playbook.

### Example Directory Structure for a New Test

```
roles/
  tests/
    test_new_feature/
      tasks/
        main.yaml
      tofu_files/
        main.tf
        servers.tf
        networks.tf
      README.md
```

## Notes

- Use the `test_skel` role to reuse common logic and reduce duplication.
- Ensure the `tofu_files/` directory contains all necessary Terraform files for provisioning.
- Follow the existing structure and conventions to maintain consistency.
- Test results are stored in the `results` dictionary and can be extended with additional information.

## License

This repository is licensed under the Apache License, Version 2.0. See the [LICENSE](https://www.apache.org/licenses/LICENSE-2.0) file for details.
